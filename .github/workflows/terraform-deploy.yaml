name: Terraform Deploy Infra

on:
  push:
    branches: [main]
    path: [./infra/**]
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options: 
          - production
          - staging 

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  TF_VERSION: "1.6.0"   

defaults: 
  run: 
    working-directory: ./infra     

jobs: 
  terraform-validate:
    name: Validate Terraform Code
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    permissions: 
      id-token: write
      contents: read

    steps: 
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
          aws-region: ${{ env.AWS_REGION }}
          
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:  
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        id: fmt 
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init (for validation)
        run: terraform init
          
          
      
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
          

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with: 
          tflint_version: latest

      - name: Run TFLint
        run: |
          tflint --init
          tflint --format compact
        continue-on-error: true
          

  terraform-plan:
    name: Terraform Plan 
    runs-on: ubuntu-latest
    needs: terraform-validate

    permissions:
      id-token: write
      contents: read

    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
          aws-region: ${{ env.AWS_REGION }}
          

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }} 

      - name: Terraform Init
        id: init
        run: terraform init 
          
               

      - name: Terraform Plan
        id: plan
        run: terraform plan
           

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/tfplan

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan   
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    environment: 
      name: production
      url: https://tm.mwaqar.co.uk
    

    permissions:
      id-token: write
      contents: read
      
    steps: 
        - name: Checkout code 
          uses: actions/checkout@v4
        
        - name: Configure AWS credentials
          uses: aws-actions/configure-aws-credentials@v4
          with: 
            role-to-assume: ${{ secrets.AWS_ROLE_ARN }} 
            aws-region: ${{ env.AWS_REGION }}
            

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{ env.TF_VERSION }} 

        - name: Terraform Init
          id: init
          run: terraform init
             
              

        

        - name: Terraform Apply
          id: apply
          run: terraform apply --auto-approve
            

        - name: Get Terraform outputs
          id: outputs
          run: |
            echo "alb_dns=$(terraform output -raw alb_dns_name)" >> $GITHUB_OUTPUT
            echo "domain=$(terraform output -raw app_fqdn)" >> $GITHUB_OUTPUT

    outputs:
      alb_dns: threatcomp-alb
      domain: https://tm.mwaqar.co.uk     


